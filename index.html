<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Offshore Resource Calculator</title>
<style>
  :root{
    --bg: #f6f8fb;
    --panel: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --ring: rgba(15,23,42,.08);
    --brand: #4f46e5;
    --good: #10b981;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --ring:rgba(0,0,0,.4);
  }

  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  html, body { 
    height:100%; 
    margin:0; 
    padding:0;
    overflow:hidden;
  }
  body{
    background:var(--bg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    display:flex;
    flex-direction:column;
  }

  /* App chrome */
  .app { 
    height:100%; 
    min-height:100%;
    display:flex; 
    flex-direction:column;
    overflow:hidden;
  }
  .appHeader{
    display:flex; 
    align-items:center; 
    justify-content:space-between;
    padding:10px 14px; 
    background:var(--panel); 
    border-bottom:1px solid var(--border);
    box-shadow:0 2px 8px var(--ring); 
    position:sticky; 
    top:0; 
    z-index:10;
    flex-shrink:0;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:700;
    font-size:15px;
  }
  .brandBadge{
    width:26px;
    height:26px;
    border-radius:8px;
    background:linear-gradient(135deg,var(--brand),#7c3aed); 
    box-shadow:0 4px 12px rgba(79,70,229,.35);
    flex-shrink:0;
  }
  .headerBtns{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .btn{
    border:1px solid var(--border); 
    background:var(--panel); 
    color:var(--text);
    padding:6px 12px; 
    border-radius:8px; 
    font-size:12px; 
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
    touch-action:manipulation;
  }
  .btn:hover{
    background:var(--bg);
    border-color:var(--brand);
  }
  .btn.primary{ 
    background:var(--brand); 
    border-color:var(--brand); 
    color:#fff;
  }
  .btn.primary:hover{
    background:#4338ca;
    border-color:#4338ca;
  }
  .btn.ghost{ 
    background:transparent; 
  }
  .btn:active{ 
    transform:scale(0.98); 
  }
  .btn.hidden{
    display:none;
  }

  /* Content */
  .appBody{ 
    flex:1; 
    overflow-y:auto; 
    overflow-x:hidden;
    -webkit-overflow-scrolling:touch;
    min-height:0;
  }
  .container{
    max-width:1200px;
    margin:16px auto;
    padding:0 14px;
    padding-bottom:20px;
  }
  .sub{
    color:var(--muted);
    font-size:13px;
    margin-bottom:16px;
    line-height:1.5;
  }
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:16px;
  }
  @media(min-width:900px){
    .grid{
      grid-template-columns:1.2fr .8fr;
    }
  }
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    box-shadow:0 4px 12px var(--ring);
    padding:16px;
  }
  .section{
    border:1px solid var(--border);
    border-radius:12px;
    padding:14px;
    margin-top:14px;
  }
  .section h3{
    margin:0 0 10px 0;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#475569;
    font-size:12px;
    font-weight:600;
  }
  .row{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  @media(min-width:600px){
    .row{
      grid-template-columns:1fr 1fr;
    }
  }
  .full{
    grid-column:1/-1;
  }
  .label{
    font-size:12px;
    color:#475569;
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  [data-theme="dark"] .label{
    color:#94a3b8;
  }
  .valueTag{
    border:1px solid var(--border);
    border-radius:6px;
    padding:3px 8px;
    font-size:11px;
    color:#475569;
    background:#fff;
    font-weight:600;
    white-space:nowrap;
  }
  [data-theme="dark"] .valueTag{
    background:#0b1220; 
    color:#cbd5e1; 
    border-color:#1f2937;
  }
  input[type=range]{
    width:100%;
    height:8px;
    -webkit-appearance:none;
    appearance:none;
    background:var(--border);
    border-radius:4px;
    outline:none;
    cursor:pointer;
    touch-action:manipulation;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:18px;
    height:18px;
    background:var(--brand);
    border-radius:50%;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(79,70,229,.3);
    transition:transform 0.1s;
  }
  input[type=range]::-webkit-slider-thumb:active{
    transform:scale(1.2);
  }
  input[type=range]::-moz-range-thumb{
    width:18px;
    height:18px;
    background:var(--brand);
    border-radius:50%;
    cursor:pointer;
    border:none;
    box-shadow:0 2px 6px rgba(79,70,229,.3);
  }
  select{
    width:100%;
    padding:8px 12px;
    border:1px solid var(--border);
    border-radius:8px;
    background:var(--panel);
    color:var(--text);
    font-size:13px;
    font-family:inherit;
    cursor:pointer;
    outline:none;
    transition:all 0.2s;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 10px center;
    padding-right:32px;
  }
  select:hover{
    border-color:var(--brand);
  }
  select:focus{
    border-color:var(--brand);
    box-shadow:0 0 0 3px var(--ring);
  }
  [data-theme="dark"] select{
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  }
  .profileHint{
    font-size:11px;
    color:var(--muted);
    font-style:italic;
    margin-bottom:12px;
    line-height:1.5;
  }
  .toggle{
    display:inline-flex;
    background:#e8eef7;
    border-radius:999px;
    padding:4px;
    gap:2px;
  }
  [data-theme="dark"] .toggle{
    background:#0b1220;
    border:1px solid #1f2937;
  }
  .toggle button{
    border:0;
    background:transparent;
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    color:#334155;
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
    touch-action:manipulation;
  }
  [data-theme="dark"] .toggle button{
    color:#cbd5e1;
  }
  .toggle .active{
    background:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    font-weight:600;
  }
  [data-theme="dark"] .toggle .active{
    background:#111827;
  }
  .kpi{
    border:1px solid var(--border);
    border-radius:12px;
    padding:14px;
    background:var(--panel);
  }
  .kpi .title{
    font-size:11px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:#64748b;
    font-weight:600;
  }
  .kpi .number{
    font-size:28px;
    font-weight:700;
    margin-top:6px;
    color:var(--text);
    line-height:1.2;
  }
  .kpi .subline{
    font-size:12px;
    color:#64748b;
    margin-top:8px;
    line-height:1.4;
  }
  .funnelTitle{
    font-size:12px;
    font-weight:600;
    color:#475569;
    text-transform:uppercase;
    letter-spacing:.08em;
    margin-bottom:12px;
  }
  .bar{
    position:relative;
    height:32px;
    border-radius:10px;
    background:#eef2f7;
    overflow:hidden;
    border:1px solid var(--border);
  }
  [data-theme="dark"] .bar{
    background:#0b1220;
  }
  .fill{
    height:100%;
    border-radius:10px;
    box-shadow:inset 0 2px 0 rgba(255,255,255,.4), inset 0 -3px 6px rgba(0,0,0,.14), 0 4px 10px rgba(0,0,0,0.08);
    transition:width 0.3s ease;
  }
  .barRow{
    margin-bottom:14px;
  }
  .barRow:last-child{
    margin-bottom:0;
  }
  .barHeader{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    margin-bottom:6px;
    gap:8px;
  }
  .barHeader .t{
    font-size:12px;
    color:#475569;
    text-transform:uppercase;
    letter-spacing:.06em;
    font-weight:600;
    flex:1;
  }
  [data-theme="dark"] .barHeader .t, 
  [data-theme="dark"] .barHeader .n{
    color:#cbd5e1;
  }
  .barHeader .n{
    font-size:12px;
    color:#475569;
    font-weight:600;
    white-space:nowrap;
  }
  .outline{
    box-shadow:0 0 0 1px rgba(15,23,42,.15) inset;
  }

  /* Teams optimizations */
  .teams-mode .container{
    max-width:100%;
    padding:12px;
  }
  .teams-mode .appHeader{
    padding:8px 12px;
  }
  .teams-mode .brand{
    font-size:14px;
  }
  .teams-mode .card{
    padding:14px;
    border-radius:12px;
  }
  .teams-mode .section{
    padding:12px;
    margin-top:12px;
  }
  .teams-mode .kpi .number{
    font-size:24px;
  }
  
  /* Responsive adjustments */
  @media(max-width:600px){
    .headerBtns{
      gap:6px;
    }
    .btn{
      padding:5px 10px;
      font-size:11px;
    }
    .brand{
      font-size:13px;
    }
    .container{
      padding:0 10px;
      padding-bottom:16px;
    }
    .card{
      padding:12px;
    }
  }
  @media(min-width:600px){
    .profileSelectWrapper{
      flex:1 1 auto !important;
      max-width:300px !important;
    }
  }
</style>
</head>
<body>
<div class="app" id="appRoot">
  <header class="appHeader">
    <div class="brand"><div class="brandBadge"></div> Offshore Resource Calculator</div>
    <div class="headerBtns">
      <button class="btn ghost" id="btnDark">Dark</button>
      <button class="btn" id="btnReset">Reset</button>
      <button class="btn primary" id="btnFullscreen">Full screen</button>
    </div>
  </header>

  <main class="appBody">
    <div class="container">
      <div class="grid">
        <div class="card">
          <div class="full">
            <div class="label"><span>Starts Needed (First‑Day Arrivals) · This Week</span><span class="valueTag" id="val-starts">75</span></div>
            <input id="starts" type="range" min="0" max="2000" step="1" value="75" oninput="if(window.updateStarts)window.updateStarts(this.value)">
          </div>

          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
              <h3 style="margin:0;flex:1 1 auto;min-width:0;">Field Recruiting Assumptions</h3>
              <div class="profileSelectWrapper" style="flex:1 1 100%;min-width:0;">
                <select id="profileSelect" style="width:100%;">
                  <option value="light-industrial" selected>Light Industrial (Entry-Level) - Default</option>
                  <option value="clerical">Clerical / Administrative</option>
                  <option value="skilled-labor">Skilled Labor (Forklift, Maintenance, Press Ops)</option>
                  <option value="professional">Professional / Technical (IT, Engineering, Analyst)</option>
                </select>
                <div class="profileHint" style="margin-top:8px;text-align:center;">Select from dropdown and/or manually adjust values below</div>
              </div>
            </div>
            <div class="row">
              <div>
                <div class="label"><span>Branch Interviews Show Rate</span><span class="valueTag" id="val-show">60%</span></div>
                <input id="show" type="range" min="0" max="100" step="1" value="60" oninput="if(window.updateShow)window.updateShow(this.value)">
              </div>
              <div>
                <div class="label"><span>Passed Interviews Rate</span><span class="valueTag" id="val-passInt">75%</span></div>
                <input id="passInt" type="range" min="0" max="100" step="1" value="75" oninput="if(window.updatePassInt)window.updatePassInt(this.value)">
              </div>
              <div>
                <div class="label"><span>Passed Screenings Rate</span><span class="valueTag" id="val-passScreen">80%</span></div>
                <input id="passScreen" type="range" min="0" max="100" step="1" value="80" oninput="if(window.updatePassScreen)window.updatePassScreen(this.value)">
              </div>
              <div>
                <div class="label"><span>1st Day Arrival Rate</span><span class="valueTag" id="val-arrive">75%</span></div>
                <input id="arrive" type="range" min="0" max="100" step="1" value="75" oninput="if(window.updateArrive)window.updateArrive(this.value)">
              </div>
            </div>
          </div>

          <div class="section">
            <div class="label" style="margin-bottom:10px;">
              <span style="font-weight:600;color:#475569;text-transform:uppercase;letter-spacing:.08em">Offshore Assumptions</span>
              <span class="toggle">
                <button id="mode-int" class="active">KPI: Interviews / Day</button>
                <button id="mode-onb">KPI: Onboards / Day</button>
              </span>
            </div>
            <div class="row">
              <div class="full" id="intWrap">
                <div class="label"><span>Branch Interviews Scheduled per Recruiter / Day</span><span class="valueTag" id="val-intpd">10</span></div>
                <input id="intpd" type="range" min="0" max="30" step="0.1" value="10" oninput="if(window.updateIntpd)window.updateIntpd(this.value)">
              </div>
              <div class="full" id="onbWrap" style="display:none;">
                <div class="label"><span>Onboards per Recruiter / Day</span><span class="valueTag" id="val-onbpd">15</span></div>
                <input id="onbpd" type="range" min="0" max="20" step="0.1" value="15" oninput="if(window.updateOnbpd)window.updateOnbpd(this.value)">
              </div>
              <div class="full">
                <div class="label"><span>Working Days / Week</span><span class="valueTag" id="val-days">5</span></div>
                <input id="days" type="range" min="1" max="7" step="1" value="5" oninput="if(window.updateDays)window.updateDays(this.value)">
              </div>
            </div>
          </div>

          <div class="section" style="margin-top:14px;">
            <h3>Recruiter Calculation Logic</h3>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">
              <div style="margin-bottom:8px;"><strong>Interviews Mode:</strong> <em>Recruiters = Interviews Required ÷ (Interviews per Day × Working Days per Week)</em></div>
              <div><strong>Onboards Mode:</strong> <em>Recruiters = Screenings Initiated ÷ (Onboards per Day × Working Days per Week)</em></div>
            </div>
          </div>
        </div>

        <div>
          <div class="grid" style="grid-template-columns:1fr;gap:12px;margin-bottom:12px;">
            <div class="kpi">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px;">
                <div style="flex:1;text-align:center;">
                  <div class="title">Interviews Required / Week</div>
                  <div class="number" id="kpi-interviews">0</div>
                  <div class="subline" style="font-style:italic;">Based on performance assumptions entered</div>
                </div>
                <div style="flex:1;text-align:center;">
                  <div class="title">Recruiting Ratio</div>
                  <div class="number" id="kpi-ratio" style="font-size:28px;">0:0</div>
                  <div class="subline">Scheduled → Start</div>
                </div>
              </div>
            </div>
            <div class="kpi" style="text-align:center;">
              <div class="title">Recruiters Needed</div>
              <div class="number" id="kpi-recruiters">0</div>
              <div class="subline" id="kpi-hint"></div>
              <div class="subline"><strong>Daily Interview Slots Required:</strong> <span id="kpi-dailyslots">0</span> / day</div>
            </div>
          </div>

          <div class="card">
            <div class="funnelTitle">Excel Recruiting Funnel</div>

            <div class="barRow">
              <div class="barHeader"><div class="t">Required Interviews Scheduled</div><div class="n" id="n-scheduled">0</div></div>
              <div class="bar outline"><div class="fill" id="bar-scheduled" style="width:100%;background:linear-gradient(90deg,#6366f1,#4338ca)"></div></div>
            </div>

            <div class="barRow">
              <div class="barHeader"><div class="t">Interviews Conducted</div><div class="n" id="n-conducted">0</div></div>
              <div class="bar"><div class="fill" id="bar-conducted" style="width:60%;background:linear-gradient(90deg,#7c3aed,#5b21b6)"></div></div>
            </div>

            <div class="barRow">
              <div class="barHeader"><div class="t">Screenings Initiated</div><div class="n" id="n-screens">0</div></div>
              <div class="bar"><div class="fill" id="bar-screens" style="width:40%;background:linear-gradient(90deg,#db2777,#9d174d)"></div></div>
            </div>

            <div class="barRow">
              <div class="barHeader"><div class="t">Confirmed to Start</div><div class="n" id="n-confirmed">0</div></div>
              <div class="bar"><div class="fill" id="bar-confirmed" style="width:30%;background:linear-gradient(90deg,#f59e0b,#b45309)"></div></div>
            </div>

            <div class="barRow">
              <div class="barHeader"><div class="t">First‑Day Arrivals (Starts)</div><div class="n" id="n-arrivals">0</div></div>
              <div class="bar"><div class="fill" id="bar-arrivals" style="width:20%;background:linear-gradient(90deg,#10b981,#047857)"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script type="text/javascript">
  // Debug logging
  console.log('Script tag loaded');
  
  // SharePoint-compatible initialization - multiple fallbacks
  (function() {
    'use strict';
    
    console.log('IIFE executing');
    
    var initialized = false;
    
    function initCalculator() {
      console.log('initCalculator called, initialized:', initialized);
      
      if (initialized) return;
      
      // Check if required elements exist
      var appRoot = document.getElementById('appRoot');
      if (!appRoot) {
        console.log('appRoot not found, retrying...');
        // Retry after a short delay if elements aren't ready
        setTimeout(initCalculator, 100);
        return;
      }
      
      console.log('Initializing calculator...');
      initialized = true;
      
      try {
        // Teams detection and initialization
        var params = new URLSearchParams(location.search);
        var appRoot = document.getElementById('appRoot');
        
        // Detect Teams environment
        var isInIframe = window.self !== window.top;
        var isTeams = params.get('mode') === 'teams' ||
                        window.location.href.indexOf('teams.microsoft.com') !== -1 ||
                        (isInIframe && (document.referrer.indexOf('teams.microsoft.com') !== -1 || 
                                        window.location.search.indexOf('teams') !== -1));
        
        // Apply Teams mode
        if (appRoot) {
          if (isTeams || isInIframe) {
            appRoot.classList.add('teams-mode');
            // Hide fullscreen button in Teams (doesn't work in iframe)
            setTimeout(function() {
              var fullscreenBtn = document.getElementById('btnFullscreen');
              if (fullscreenBtn) fullscreenBtn.classList.add('hidden');
            }, 0);
          }
        }
        
        // Theme handling
        if (params.get('theme') === 'dark') {
          document.documentElement.setAttribute('data-theme','dark');
        }

        // Ensure proper height handling in iframe
        function adjustHeight() {
          if (isTeams) {
            document.body.style.height = '100%';
            document.documentElement.style.height = '100%';
          }
        }
        
        // Adjust on load and resize
        window.addEventListener('load', adjustHeight);
        window.addEventListener('resize', adjustHeight);
        
        // Try to communicate with Teams iframe (if available)
        if (isTeams && window.parent !== window) {
          try {
            // Notify parent of ready state
            window.parent.postMessage({ type: 'ready', source: 'offshore-calculator' }, '*');
          } catch(e) {
            // Cross-origin restrictions - ignore
          }
        }

        var el = function(id) {
          var elem = document.getElementById(id);
          if (!elem) {
            console.error('Element not found:', id);
          }
          return elem;
        };
        
        var DEFAULTS = {
          starts: 75, 
          show: 0.60, 
          passInt: 0.75, 
          passScreen: 0.80, 
          arrive: 0.75,
          mode: 'interviews', 
          intpd: 10, 
          onbpd: 15, 
          days: 5
        };
        
        // Recruiting profile data
        var PROFILES = {
          'light-industrial': {
            name: 'Light Industrial (Entry-Level)',
            show: 0.60,
            passScreen: 0.80,
            passInt: 0.75,
            arrive: 0.75,
            intpd: 10.0
          },
          'clerical': {
            name: 'Clerical / Administrative',
            show: 0.70,
            passScreen: 0.80,
            passInt: 0.60,
            arrive: 0.85,
            intpd: 8.0
          },
          'skilled-labor': {
            name: 'Skilled Labor (Forklift, Maintenance, Press Ops)',
            show: 0.65,
            passScreen: 0.70,
            passInt: 0.50,
            arrive: 0.85,
            intpd: 6.0
          },
          'professional': {
            name: 'Professional / Technical (IT, Engineering, Analyst)',
            show: 0.75,
            passScreen: 0.65,
            passInt: 0.45,
            arrive: 0.90,
            intpd: 4.0
          }
        };
        var state = {};
        for (var key in DEFAULTS) {
          if (DEFAULTS.hasOwnProperty(key)) {
            state[key] = DEFAULTS[key];
          }
        }
        
        // Make state globally accessible for inline handlers
        window.calculatorState = state;

        function syncRangesFromState(){
          var startsEl = el('starts');
          var showEl = el('show');
          var passIntEl = el('passInt');
          var passScreenEl = el('passScreen');
          var arriveEl = el('arrive');
          var intpdEl = el('intpd');
          var onbpdEl = el('onbpd');
          var daysEl = el('days');
          
          if (startsEl) {
            startsEl.value = String(state.starts);
            var startsTag = el('val-starts');
            if (startsTag) startsTag.textContent = state.starts;
          }
          if (showEl) {
            showEl.value = String(Math.round(state.show*100));
            var showTag = el('val-show');
            if (showTag) showTag.textContent = Math.round(state.show*100)+'%';
          }
          if (passIntEl) {
            passIntEl.value = String(Math.round(state.passInt*100));
            var passIntTag = el('val-passInt');
            if (passIntTag) passIntTag.textContent = Math.round(state.passInt*100)+'%';
          }
          if (passScreenEl) {
            passScreenEl.value = String(Math.round(state.passScreen*100));
            var passScreenTag = el('val-passScreen');
            if (passScreenTag) passScreenTag.textContent = Math.round(state.passScreen*100)+'%';
          }
          if (arriveEl) {
            arriveEl.value = String(Math.round(state.arrive*100));
            var arriveTag = el('val-arrive');
            if (arriveTag) arriveTag.textContent = Math.round(state.arrive*100)+'%';
          }
          if (intpdEl) {
            intpdEl.value = String(state.intpd);
            var intpdTag = el('val-intpd');
            if (intpdTag) intpdTag.textContent = state.intpd.toFixed(1);
          }
          if (onbpdEl) {
            onbpdEl.value = String(state.onbpd);
            var onbpdTag = el('val-onbpd');
            if (onbpdTag) onbpdTag.textContent = state.onbpd.toFixed(1);
          }
          if (daysEl) {
            daysEl.value = String(state.days);
            var daysTag = el('val-days');
            if (daysTag) daysTag.textContent = state.days;
          }
          
          var modeInt = el('mode-int');
          var modeOnb = el('mode-onb');
          var intWrap = el('intWrap');
          var onbWrap = el('onbWrap');
          
          if(state.mode==='interviews'){
            if (modeInt) modeInt.classList.add('active');
            if (modeOnb) modeOnb.classList.remove('active');
            if (intWrap) intWrap.style.display='block';
            if (onbWrap) onbWrap.style.display='none';
          } else {
            if (modeOnb) modeOnb.classList.add('active');
            if (modeInt) modeInt.classList.remove('active');
            if (intWrap) intWrap.style.display='none';
            if (onbWrap) onbWrap.style.display='block';
          }
        }

        function arrayIncludes(arr, val) {
          for (var i = 0; i < arr.length; i++) {
            if (arr[i] === val) return true;
          }
          return false;
        }

        function bindRange(id, key){
          var input = el(id);
          if (!input) {
            console.error('Input not found:', id);
            return;
          }
          var tag = el('val-'+key) || el('val-'+id);
          if (!tag) {
            console.error('Tag not found for:', key);
            return;
          }
          input.addEventListener('input', function(){
            var val = parseFloat(input.value);
            if(arrayIncludes(['show','passInt','passScreen','arrive'], key)) { 
              state[key] = val/100; 
              tag.textContent = Math.round(val)+'%'; 
            } else { 
              state[key] = val; 
              tag.textContent = (key==='intpd'||key==='onbpd') ? val.toFixed(1) : val; 
            }
            calc();
          });
        }

        // Bind all range inputs
        var rangeIds = ['starts','show','passInt','passScreen','arrive','intpd','onbpd','days'];
        for (var i = 0; i < rangeIds.length; i++) {
          bindRange(rangeIds[i], rangeIds[i]);
        }

        // Bind mode toggle buttons
        var modeIntBtn = el('mode-int');
        var modeOnbBtn = el('mode-onb');
        if (modeIntBtn) {
          modeIntBtn.addEventListener('click', function(){ 
            state.mode='interviews'; 
            syncRangesFromState(); 
            calc(); 
          });
        }
        if (modeOnbBtn) {
          modeOnbBtn.addEventListener('click', function(){ 
            state.mode='onboards'; 
            syncRangesFromState(); 
            calc(); 
          });
        }

        // Bind profile selector
        var profileSelect = el('profileSelect');
        if (profileSelect) {
          profileSelect.addEventListener('change', function(){
            var profileKey = this.value;
            if (PROFILES[profileKey]) {
              var profile = PROFILES[profileKey];
              state.show = profile.show;
              state.passScreen = profile.passScreen;
              state.passInt = profile.passInt;
              state.arrive = profile.arrive;
              state.intpd = profile.intpd;
              syncRangesFromState();
              calc();
            }
          });
        }

        // Bind reset button
        var resetBtn = el('btnReset');
        if (resetBtn) {
          resetBtn.addEventListener('click', function(){ 
            for (var key in DEFAULTS) {
              if (DEFAULTS.hasOwnProperty(key)) {
                state[key] = DEFAULTS[key];
              }
            }
            if (profileSelect) {
              profileSelect.value = 'light-industrial';
            }
            syncRangesFromState(); 
            calc(); 
          });
        }

        // Bind dark mode button
        var darkBtn = el('btnDark');
        if (darkBtn) {
          darkBtn.addEventListener('click', function(){
            var cur = document.documentElement.getAttribute('data-theme');
            if(cur==='dark') document.documentElement.removeAttribute('data-theme');
            else document.documentElement.setAttribute('data-theme','dark');
          });
        }

        // Bind fullscreen button
        var fullscreenBtn = el('btnFullscreen');
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', function(){
            if (isInIframe) {
              // In iframe, open in new window instead
              window.open(window.location.href.replace(/\?.*$/, ''), '_blank');
            } else {
              var elem = document.documentElement; 
              if(!document.fullscreenElement){ 
                if (elem.requestFullscreen) elem.requestFullscreen();
              } else { 
                if (document.exitFullscreen) document.exitFullscreen();
              }
            }
          });
        }

        function formatInt(n){ 
          return new Intl.NumberFormat().format(Math.round(n)); 
        }

        function calc(){
          try {
            // Use window.calculatorState if state isn't accessible
            var calcState = window.calculatorState || state;
            var arrivals = calcState.starts;
            var confirmed = arrivals / Math.max(0.0001, calcState.arrive);
            var screens = confirmed / Math.max(0.0001, calcState.passScreen);
            var conducted = screens / Math.max(0.0001, calcState.passInt);
            var scheduled = conducted / Math.max(0.0001, calcState.show);

            // KPIs
            var interviewsReq = Math.ceil(scheduled);
            var recruiters = 0;
            var hint = '';
            if(calcState.mode==='interviews'){
              var perWeek = Math.max(0.01, calcState.intpd * calcState.days);
              recruiters = Math.ceil(interviewsReq / perWeek);
              hint = calcState.intpd.toFixed(1) + ' interviews/day · ' + calcState.days + ' days';
            } else {
              var perWeek = Math.max(0.01, calcState.onbpd * calcState.days);
              recruiters = Math.ceil(screens / perWeek);
              hint = calcState.onbpd.toFixed(1) + ' onboards/day · ' + calcState.days + ' days';
            }

            // Daily Interview Slots Required (team total)
            var dailySlots = Math.ceil(interviewsReq / Math.max(1, calcState.days));

            // Calculate Recruiting Ratio (Scheduled → Start)
            // Format as 1:X where X is scheduled/starts, rounded to 1 decimal
            function calculateRatio(scheduled, starts) {
              if (scheduled === 0 || starts === 0) return '0:0';
              var ratio = scheduled / starts;
              return '1:' + ratio.toFixed(1);
            }
            var recruitingRatio = calculateRatio(scheduled, arrivals);

            // update KPIs
            var kpiInterviews = el('kpi-interviews');
            var kpiRecruiters = el('kpi-recruiters');
            var kpiHint = el('kpi-hint');
            var kpiDailySlots = el('kpi-dailyslots');
            var kpiRatio = el('kpi-ratio');
            
            if (kpiInterviews) kpiInterviews.textContent = formatInt(interviewsReq);
            if (kpiRecruiters) kpiRecruiters.textContent = formatInt(recruiters);
            if (kpiHint) kpiHint.textContent = hint;
            if (kpiDailySlots) kpiDailySlots.textContent = formatInt(dailySlots);
            if (kpiRatio) kpiRatio.textContent = recruitingRatio;

            // update bars & numbers
            var max = Math.max(1, scheduled);
            function width(v){ return Math.max(2, Math.round((v/max)*100)); }
            
            var nScheduled = el('n-scheduled');
            var nConducted = el('n-conducted');
            var nScreens = el('n-screens');
            var nConfirmed = el('n-confirmed');
            var nArrivals = el('n-arrivals');
            
            if (nScheduled) nScheduled.textContent = formatInt(scheduled);
            if (nConducted) nConducted.textContent = formatInt(conducted);
            if (nScreens) nScreens.textContent = formatInt(screens);
            if (nConfirmed) nConfirmed.textContent = formatInt(confirmed);
            if (nArrivals) nArrivals.textContent = formatInt(arrivals);

            var barScheduled = el('bar-scheduled');
            var barConducted = el('bar-conducted');
            var barScreens = el('bar-screens');
            var barConfirmed = el('bar-confirmed');
            var barArrivals = el('bar-arrivals');
            
            if (barScheduled) barScheduled.style.width = width(scheduled)+'%';
            if (barConducted) barConducted.style.width = width(conducted)+'%';
            if (barScreens) barScreens.style.width = width(screens)+'%';
            if (barConfirmed) barConfirmed.style.width = width(confirmed)+'%';
            if (barArrivals) barArrivals.style.width = width(arrivals)+'%';
          } catch(error) {
            console.error('Calculation error:', error);
          }
        }

        // Expose update functions globally for inline event handlers
        window.updateStarts = function(val) {
          var calcState = window.calculatorState || state;
          calcState.starts = parseFloat(val);
          var tag = document.getElementById('val-starts');
          if (tag) tag.textContent = val;
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updateShow = function(val) {
          var calcState = window.calculatorState || state;
          calcState.show = parseFloat(val)/100;
          var tag = document.getElementById('val-show');
          if (tag) tag.textContent = Math.round(val)+'%';
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updatePassInt = function(val) {
          var calcState = window.calculatorState || state;
          calcState.passInt = parseFloat(val)/100;
          var tag = document.getElementById('val-passInt');
          if (tag) tag.textContent = Math.round(val)+'%';
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updatePassScreen = function(val) {
          var calcState = window.calculatorState || state;
          calcState.passScreen = parseFloat(val)/100;
          var tag = document.getElementById('val-passScreen');
          if (tag) tag.textContent = Math.round(val)+'%';
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updateArrive = function(val) {
          var calcState = window.calculatorState || state;
          calcState.arrive = parseFloat(val)/100;
          var tag = document.getElementById('val-arrive');
          if (tag) tag.textContent = Math.round(val)+'%';
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updateIntpd = function(val) {
          var calcState = window.calculatorState || state;
          calcState.intpd = parseFloat(val);
          var tag = document.getElementById('val-intpd');
          if (tag) tag.textContent = parseFloat(val).toFixed(1);
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updateOnbpd = function(val) {
          var calcState = window.calculatorState || state;
          calcState.onbpd = parseFloat(val);
          var tag = document.getElementById('val-onbpd');
          if (tag) tag.textContent = parseFloat(val).toFixed(1);
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        window.updateDays = function(val) {
          var calcState = window.calculatorState || state;
          calcState.days = parseFloat(val);
          var tag = document.getElementById('val-days');
          if (tag) tag.textContent = val;
          if (window.calculatorCalc) window.calculatorCalc();
          else calc();
        };
        
        // Make calc function globally accessible
        window.calculatorCalc = calc;

        // Initialize
        syncRangesFromState();
        calc();
        console.log('Calculator initialized successfully');
      } catch(error) {
        console.error('Initialization error:', error);
      }
    }
    
    // Multiple initialization methods for SharePoint compatibility
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCalculator);
    } else {
      // DOM already loaded, try immediately
      initCalculator();
    }
    
    // Fallback: window.onload
    window.addEventListener('load', function() {
      setTimeout(initCalculator, 0);
    });
    
    // Immediate fallback for SharePoint
    setTimeout(initCalculator, 500);
  })();
</script>
</body>
</html>
